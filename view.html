<html>
<head>
  <title>Rockets!</title>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.10/socket.io.min.js" type="text/javascript"></script>
  <style type="text/css">
    body {
      margin: 0px;
      padding: 0px;
    }
  </style>
</head>
<body>
  <canvas id="space"></canvas>

  <script type="text/javascript">
    var canvas = document.getElementById('space');
    var width = canvas.width = document.width;
    var height = canvas.height = document.height;

    var ctx = canvas.getContext('2d');
    var gameRunning = true;
    var rockets = [];

    function findRocket(id) {
      var match = null;

      rockets.forEach(function(rocket) {
        if (rocket.id == id) {
          match = rocket;
        }
      });

      return match;
    }

    function createRocket(rocketData) {
      var rocket = {
        id: rocketData.id,
        x: width * Math.random(),
        y: height * Math.random(),
        speed: 0.1,
        angle: 0,
        size: 5
      };
      rockets.push(rocket);
      return rocket;
    }

    function drawWorld() {
      ctx.fillText(rockets.length, 20, 20);
      rockets.forEach(function(rocket) {
        drawRocket(rocket);
      });
    }

    function drawRocket(rocket) {
      var shift = {x: Math.cos(rocket.angle), y: -Math.sin(rocket.angle)}
      rocket.x += rocket.speed * shift.x;
      rocket.y += rocket.speed * shift.y;
      rocket.x = Math.abs(rocket.x + width) % width;
      rocket.y = Math.abs(rocket.y + height) % height;
      ctx.beginPath();
      ctx.arc(rocket.x, rocket.y, rocket.size, 0, 2 * Math.PI);
      ctx.fill();

      var tail = {length: rocket.speed * 5 + Math.random() * 10};
      tail.x = rocket.x - tail.length * shift.x;
      tail.y = rocket.y - tail.length * shift.y;
      tail.angle = Math.atan2(tail.length, rocket.size);

      var angle1 = rocket.angle + tail.angle;
      var point1 = {x: rocket.x + rocket.size * Math.cos(angle1), y: rocket.y - rocket.size * Math.sin(angle1)};
      var angle2 = rocket.angle - tail.angle;
      var point2 = {x: rocket.x + rocket.size * Math.cos(angle2), y: rocket.y - rocket.size * Math.sin(angle2)};

      ctx.beginPath();
      ctx.moveTo(point2.x, point2.y);
      ctx.lineTo(tail.x, tail.y);
      ctx.lineTo(point1.x, point1.y);
      ctx.stroke();
    }

    var socket = io.connect('http://localhost:8080');
    socket.emit('serve');
    socket.on('control', function (data) {
      var rocket = findRocket(data.id) || createRocket(data);

      rocket.angle = data.angle;
      rocket.speed = data.speed;
    });

    (function loop() {
      ctx.clearRect(0, 0, width, height);
      drawWorld();
      if (gameRunning) {
        window.requestAnimationFrame(loop);
      }
    })();
  </script>
</body>
</html>