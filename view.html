<html>
<head>
  <title>Rockets!</title>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.10/socket.io.min.js" type="text/javascript"></script>
  <style type="text/css">
    body {
      margin: 0px;
      padding: 0px;
      background-color: black;
    }
  </style>
</head>
<body>
  <canvas id="space"></canvas>

  <script type="text/javascript">
    var canvas = document.getElementById('space');
    var width = canvas.width = document.width;
    var height = canvas.height = document.height;

    var ctx = canvas.getContext('2d');
    var gameRunning = true;
    var rockets = [];
    var bonus = {};

    function createBonus() {
      var size = Math.max(bonus.size ? bonus.size * 0.9 : 80, 3),
          x = (width - 2 * size) * Math.random() + size,
          y = (height - 2 * size) * Math.random() + size;

      bonus = {size: size, x: x, y: y};
    }

    function findRocket(id) {
      var match = null;

      rockets.forEach(function(rocket) {
        if (rocket.id == id) {
          match = rocket;
        }
      });

      return match;
    }

    function createRocket(rocketData) {
      var rocket = {
        id: rocketData.id,
        x: width * Math.random(),
        y: height * Math.random(),
        speed: 0.1,
        angle: 0,
        size: 10,
        score: 0,
        color: rocketData.color
      };
      rockets.push(rocket);
      return rocket;
    }

    function drawWorld() {
      rockets.forEach(function(rocket, idx) {
        drawRocket(rocket);
        ctx.font = 'bold 40px Helvetica';
        ctx.fillText(rocket.score, 10, 40 * (idx + 1));
        checkForBonus(rocket);
      });
      ctx.strokeStyle = '#ffffff';
      ctx.beginPath();
      ctx.arc(bonus.x, bonus.y, bonus.size, 0, 2 * Math.PI);
      ctx.stroke();
    }

    function drawRocket(rocket) {
      var shift = {x: Math.cos(rocket.angle), y: -Math.sin(rocket.angle)}
      rocket.x += rocket.speed * shift.x;
      rocket.y += rocket.speed * shift.y;
      rocket.x = Math.abs(rocket.x + width) % width;
      rocket.y = Math.abs(rocket.y + height) % height;

      var tail = {length: rocket.speed * 5 + Math.random() * 7};
      tail.x = rocket.x - tail.length * shift.x;
      tail.y = rocket.y - tail.length * shift.y;
      tail.angle = Math.atan2(tail.length, rocket.size);

      var angle1 = rocket.angle + tail.angle;
      var point1 = {x: rocket.x + rocket.size * 0.6 * Math.cos(angle1), y: rocket.y - rocket.size * 0.6 * Math.sin(angle1)};
      var angle2 = rocket.angle - tail.angle;
      var point2 = {x: rocket.x + rocket.size * 0.6 * Math.cos(angle2), y: rocket.y - rocket.size * 0.6 * Math.sin(angle2)};

      var points = [
        {x: rocket.x, y: rocket.y - rocket.size},
        {x: rocket.x, y: rocket.y + rocket.size},
        {x: rocket.x + rocket.size * 2, y: rocket.y}
      ];
      var rotated = points.map(function (point) { return  rotate(point, rocket, - rocket.angle); });

      ctx.strokeStyle = ctx.fillStyle = rocket.color;
      ctx.beginPath();
      ctx.moveTo(rotated[0].x, rotated[0].y);
      rotated.forEach(function (p) {
        ctx.lineTo(p.x, p.y);
      });
      ctx.fill();

      if (Math.abs(rocket.speed) < 1)
        return;

      ctx.beginPath();
      ctx.moveTo(point2.x, point2.y);
      ctx.lineTo(tail.x, tail.y);
      ctx.lineTo(point1.x, point1.y);
      ctx.stroke();
    }

    function rotate (point, center, angle) {
      return {
        x: Math.cos(angle) * (point.x - center.x) - Math.sin(angle) * (point.y - center.y) + center.x,
        y: Math.sin(angle) * (point.x - center.x) + Math.cos(angle) * (point.y - center.y) + center.y
      }
    }

    var socket = io.connect('http://' + window.location.host);
    socket.emit('serve');
    socket.on('control', function (data) {
      var rocket = findRocket(data.id) || createRocket(data);

      rocket.lastActive = new Date().getTime();
      rocket.angle = data.angle;
      rocket.speed = data.speed;
    });

    function checkForBonus(rocket) {
      var dx = rocket.x - bonus.x,
          dy = rocket.y - bonus.y;
      if (dx * dx + dy * dy < bonus.size * bonus.size) {
        rocket.score += 1;
        socket.emit('score', {id: rocket.id, score: rocket.score});

        var x = bonus.x, y = bonus.y, r = bonus.size, w = 15;
        (function wave() {
          r += 3; w -= 1;
          ctx.strokeStyle = rocket.color;
          ctx.beginPath();
          ctx.arc(x, y, r, 0, 2 * Math.PI);
          ctx.stroke();
          if (w > 0) {
            setTimeout(function() {requestAnimationFrame(wave)}, 15);
          }
        })();
        createBonus();
      }
    }

    setInterval(function () {
      var now = new Date().getTime();
      rockets = rockets.filter(function (rocket) {
        return now - rocket.lastActive < 20000;
      });
    }, 1000);

    createBonus();

    (function loop() {
      ctx.clearRect(0, 0, width, height);
      drawWorld();
      if (gameRunning) {
        window.requestAnimationFrame(loop);
      }
    })();
  </script>
</body>
</html>